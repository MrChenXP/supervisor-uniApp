<!-- 登录页面 -->
<template>
	<view class="kw-login" >
    <!-- 上面背景背景图 -->
    <view class="kw-login-title">
      <image class="kw-login-img" src="../../static/images/loginBG.png" mode="scaleToFill"></image>
      <view class="kw-login-title-ico" @tap="close()">
        <uni-icon color="white" type="closeempty" size="35"></uni-icon>
      </view>
    </view>
    <!-- 表单 -->
		<form class="kw-login-form">
      <view class="kw-login-input_bg">
				<input type="text" v-model="userName" placeholder="请输入用户名"/>
			</view>
			<view class="kw-login-input_bg">
				<input password v-model="passWord" placeholder="请输入密码"/>
			</view>
			<view v-show="vcodeShow" class="kw-login-input_bg">
				<input class="kw-login-input_yzm" type="text" v-model="vcode" placeholder="请输入验证码" />
				<image :src="vcodeUrl" @tap="toggerVcode" style="width: 75px;height: 33px;"></image>
			</view>
			<view class="kw-login-input_bg" >
				<button @tap="login()">登录</button>
			</view>
      <view class="kw-login-info" v-show="vcodeShow">点击验证码图片刷新验证码</view>
		</form>
	</view>
</template>

<script>
	export default {
    name: "kw-login",
		data() {
			return {
				title: '教育创新教育云平台',
				userName: 'dddx',
				passWord: '1234qwer',
				vcode: '',
				vcodeUrl: '../../static/logo.png',
				vcodeShow: false,
				aniShow: 'false' // 关闭动画的显示隐藏
			}
		},
		onLoad() {
			this.init()
		},
		methods: {
			login () {
				if (!this.userName || !this.userName.trim()) {
					this.$kwz.alert('用户名不能为空')
					return 
				}
				if (!this.passWord) {
					this.$kwz.alert('密码不能为空')
					return 
				}
				let param = {
					login_username: this.userName,
					login_pwd: this.passWord,
					login_yzm: this.vcode
				}
				this.$kwz.ajax.ajax({
					url: 'login/open/doLogin',
					type: 'POST',
					vue: this,
					data: {
					  params: JSON.stringify(param)
					},
					success (data) {
						if(data.statusCode == '200') {
							uni.setStorage({
								key: '_login',
								data: 'success',
							})
							uni.setStorage({
								key: '_login_milles',
								data: new Date().getTime(),
							})
							this.$kwz.initToken(()=>{
// 								this.$kwz.loadLoginUser(()=>{
//                   this.$kwz.loadProducts(()=>{
								this.$kwz.autoLogin(() => {
									this.$emit('loginSuccess')
								}, this)
//                   }, this)
//                 }, this)
							}, this)
						} else if(data.statusCode == '500'){
							this.vcodeShow = true
							this.toggerVcode()
						} else if(data.statusCode == '102' || (data.statusCode == '304' && !this.vcodeShow) ){
							this.toggerVcode()
						}
					}
				})
			},
			// init 
			init () {
				this.toggerVcode()
			},
			hidePopup () {
				this.popup.showPopup = false
			},
			toggerVcode () {
				let vcodeUrl = 'jc_yzm/open/getYzm?yzm=' + Math.random();
				vcodeUrl += this.$kwz.token ? ('&token=' + this.$kwz.token) : ''
				this.$kwz.ajax.loadSource(vcodeUrl, (imgUrl) => {
					this.vcodeUrl = imgUrl
				}, this)
				this.$emit('toggerVcode')
			},
			close () {
			this.$emit('closeLogin');
      }
		}
	}
</script>

<style lang="scss">
  @keyframes TopToBottom {
    from{transform: translateY(-100%);}
    to{transform: translateY(0);}
    /* from{transform: translateY(100%);} */
    /* to{transform: translateY(0);} */
  }
 /* @keyframes BottomToTop{
    from{transform: translateY(0);}
    to{transform: translateY(100%);}
  }  */ 
	.kw-login {
    animation: TopToBottom 1.5s;
		text-align: center;
    position: fixed;
    top: 0;
    width: 750upx;
    height: 100%;
    background: white;
    z-index: 1001;
	}
 /* .kw-login-BottomToTop{
    animation: BottomToTop 1.5s;
  } */
  .kw-login-title{
    height: 400upx;
    background-image: linear-gradient(to bottom, #028edf 0%, #00befe 100%);
    position: relative;
    margin-bottom: 40upx;
  }
  .kw-login-img{
    position: absolute;
    height: 126upx;
    width: 100%;
    left: 0;
    bottom: 0;
  }
  /* .title uni-icon{ */
 .kw-login-title-ico{
   position: fixed;
    top: 15upx;
    right: 15upx;
  }
  .kw-login-input_bg{
    width: 544upx;
    height: 85upx;
    border-radius: 42.5upx;
    border: solid 1upx #e1e1e1;
    margin: 25upx auto;
    display: flex;
  }
  .kw-login-input_bg input{
    margin-left: 47upx;
    margin-right:47upx;
    line-height: 83upx;
    height: 83upx;
    width: 100%;
    font-size: 30upx;
    color: #b0b0b0;
  }
  .kw-login-input_bg .kw-login-input-placeholder{
    text-align: left;
  }
  .kw-login-input_bg input{
    text-align: left;
  }
  .kw-login-input_yzm{
    margin-right: 0 !important;
    width: 331upx !important;
  }
  .kw-login-input_bg image{
    width: 135upx !important;
    height: 55upx !important;
    margin-top: 14upx;
    border-radius: 22.5upx;
  }
  .kw-login-input_bg button{
    padding: 0;
    margin: 0;
    width: 100%;
    border-radius: 42.5upx;
    background: linear-gradient(90deg, #00befe 0%, #028edf 100%), linear-gradient(#109dea, #109dea);
    color: white;
    line-height: 83upx;
  }
  .kw-login-input_bg button:after{
    border: none;
  }
  .kw-login-info{
    color:#109dea;
    width: 544upx;
    margin: 25upx auto;
    text-align: left;
  }
</style>
